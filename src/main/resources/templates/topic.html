<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
 <link rel="stylesheet" href="css/topic.css">
 <link rel="stylesheet" href="css/header.css">

  <script src="https://code.jquery.com/jquery-3.6.1.min.js"
          integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ="
          crossorigin="anonymous"></script>


  <script th:inline="javascript">


      //ë©”ì„¸ì§€ ì¶œë ¥
      $(function () {
          let m = [[${msg}]];
          if (m != null) {
              alert(m);
          }


          let pageNum=null ;
          let category=null ;
        console.log(pageNum)

          //ë©”ì¸->í† í”½ ì´ë™ ì‹œ ë§¤í•‘ ì²˜ë¦¬
          $(function () {
              if ([[${category}]] != null) {
                  category = [[${category}]];
              } else {
                  category = "ì „ì²´"
              }
              getTopic(category, pageNum)
          })

          //í˜ì´ì§€ ì—´ë¦¬ë©´ ê¸€ ì¶œë ¥


          //ì£¼ì œ í´ë¦­ì‹œ, í•´ë‹¹ ê¸€ ì¶œë ¥
          $('li').click(function () {
              pageNum = null;
              category = $(this).text();
              console.log(pageNum)
              console.log(category)
              $('.post_area').empty();
              getTopic(category, pageNum)
          });


          //ê¸€ ì¶œë ¥í•˜ê¸°(20ê°œ)
          function getTopic(category, pageNum) {
              let nowDate = new Date().getTime();
              $.ajax({
                  type: 'get',
                  url: "getTopicList",
                  dataType: "JSON",
                  data: {
                      "category": category,
                      "pageNum": pageNum
                  },
                  success: [function (topicList) {

                      $.each(topicList, function (idx, board) {

                          if (topicList == null) {
                              alert("ë”ì´ìƒ ì‘ì„±ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.")
                              return;
                          }
                          let fromNow;

                          let a = new Date(board.bdate);
                          let writtenDate = a.getTime();

                          console.log("bdate =  " + board.bdate)


                          let timeGap = (nowDate - writtenDate) / 1000 / 60;

                          if (timeGap < 1) {
                              fromNow = "ë°©ê¸ˆì „";
                          } else if (1 <= timeGap && timeGap < 60) {
                              fromNow = Math.floor(timeGap) + "ë¶„ì „";
                          } else if (60 <= timeGap && timeGap < 60 * 24) {
                              fromNow = Math.floor(timeGap / 60) + "ì‹œê°„ì „";
                          } else if (60 * 24 <= timeGap && timeGap < 60 * 24 * 30) {
                              fromNow = Math.floor(timeGap / 60 / 24) + "ì¼ì „";
                          } else if (60 * 24 * 30 <= timeGap && timeGap < 60 * 24 * 30 * 12) {
                              fromNow = Math.floor(timeGap / 60 / 24 / 30) + "ë‹¬ì „";
                          } else {
                              fromNow = Math.floor(timeGap / 60 / 24 / 30 / 12) + "ë…„ì „";
                          }
                          console.log(fromNow);

                          let $postWrap = $('<div class="post_wrap">').appendTo('.post_area');
                          let $infoWrap = ($postWrap).append('<div class="info_wrap">');

                          $('<span class="post_category">').html(board.bcategory).appendTo($postWrap);
                          $('<div class="post_title readPost">').html('<span >' + board.btitle + '</span>').appendTo($postWrap);
                          $('<div class="post_content readPost">').html('<span >' + board.bcontent + '</span>').appendTo($postWrap);
                          $('<span class="hidden">').html(board.bno).appendTo($postWrap);


                          $('<span class="post_writer">').html(board.mbid.mcname + " Â· " + board.mbid.mid + '</br>').appendTo($postWrap);
                          // $('<span class="post_info">').html("íšŒì‚¬ëª…: " + board.mbid.mcname ).appendTo($infoWrap);
                          // $('<span class="post_info">').html("ì‘ì„±ì: " + board.mbid.mid ).appendTo($infoWrap);
                          $('<span class="post_info">').html("ğŸ‘ : " + board.blike).appendTo($infoWrap);
                          $('<span class="post_info">').html("ğŸ’¬ : " + board.bcomment).appendTo($infoWrap);
                          $('<span class="post_info">').html("ì¡°íšŒìˆ˜ : " + board.bview).appendTo($infoWrap);
                          // $('<span class="post_info">').html(board.bdate).appendTo($infoWrap);
                          $('<span class="post_date post_info">').html(fromNow).appendTo($infoWrap);

                      });
                  }],
                  error: [function (error) {
                      console.log(error)
                  }]
              });
          }

          //ë¬´í•œí˜ì´ì§•
          $(window).scroll(function () {
              console.log("Math.round($(window).scrollTop() = " + Math.round($(window).scrollTop()))
              console.log(" $(document).height() - $(window).height() = " + $(document).height() + "-" + $(window).height())
              console.log("ì°¨ì´ = " + parseInt($(document).height() - $(window).height()))

              if (Math.round(parseInt($(window).scrollTop())) == $(document).height() - $(window).height()) {
                  pageNum++;
                  console.log("pageNum = " + pageNum)
                  getTopic(category, pageNum);
              }
          })


          //ìƒì„¸ë³´ê¸° í˜ì´ì§€ ì´ë™
          $(document).on("click", ".readPost", function () {
              let bno = $(this).siblings('.hidden').text();
              console.log("bno = " + bno)
              location.href = "detail?bno=" + bno;
          })

      })
      //ë‚ ì§œ ê³„ì‚°


  </script>

</head>
<body>
<header>
  <th:block th:include="header.html"></th:block>
</header>
<section>
  <div class="topic_wrap">
    <ol>
      <li>ì „ì²´</li>
      <li>ë² ìŠ¤íŠ¸</li>
      <li>ë¸”ë¼ë¸”ë¼</li>
      <li>íšŒì‚¬ìƒí™œ</li>
      <li>ì£¼ì‹/íˆ¬ì</li>
      <li>ì¸/ì—°ì• </li>
      <li>ê²°í˜¼</li>
      <li>ë¼ì´í”„</li>
    </ol>
  </div>
  <br>

  <span id="categoryPrint"></span>


  <div class="post_area">

<!--    <div style="display: flex">-->
<!--      <span>new</span>-->
<!--      <span>hot</span>-->

<!--    </div>-->

  </div>

</section>
<footer>
  <!--  <th:block th:include="footer.html"></th:block>-->
</footer>
</body>

</html>