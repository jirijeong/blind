<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ê²Œì‹œê¸€ ìƒì„¸í˜ì´ì§€</title>
  <link rel="stylesheet" href="css/detail.css">
  <script src="https://code.jquery.com/jquery-3.6.1.min.js"
          integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
  <th:block th:include="header.html"></th:block>

</head>
<body>

<div id="wrapdiv">
  <div class="content">
    <div class="view_head">
      <div class="category" th:text="${board.bcategory}"></div>
      <div class="content_title" th:text="${board.btitle}"></div>
      <div>
        <span th:text="${board.mbid.mcname}"></span>
        <span th:text="${board.mbid.mid}"></span>
      </div>
      <div class="info">
        <span th:text="${board.bview}"></span> Â·
        <span th:text="${board.bcomment}"></span> Â·
        <!--            <span th:text="${}"></span> &lt;!&ndash;ì‹œê°„ ë„£ì„ ê³³&ndash;&gt;-->
      </div>
    </div>
  </div>
  <div>
    <div class="bcontent" th:text="${board.bcontent}"></div>
    <div>
      <button id="upbtn" class="hidden">ìˆ˜ì •</button>
      <button id="delbtn" class="hidden">ì‚­ì œ</button>
      <button id="backbtn">ë’¤ë¡œê°€ê¸°</button>
    </div>
  </div>

  <!-- ì²¨ë¶€íŒŒì¼ ì¶œë ¥ ë¶€ë¶„-->
  <div>
    <div class="">FILES</div>
    <!--    <div class="d_content p-85 file_h" style="overflow: auto;">-->
    <th:block th:if="${#lists.isEmpty(bfList)}">
      ì²¨ë¶€ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.
    </th:block>
    <th:block th:unless="${#lists.isEmpty(bfList)}">
      <th:block th:each="bf:${bfList}">
        <a th:href="@{download(fsysname=${bf.fsysname},foriname=${bf.foriname})}">
          <span class="file-title" th:text="${bf.foriname}"></span>
        </a>
      </th:block>
    </th:block>
  </div>


  <div class="reply_wrap">
    <th:block th:if="${session.member}!=null">
      <div class="reply">
        <form action="cWriteProc" method="post" id="replyfrm" class="reply_form">
          <!--      ì‘ì„±ì cnameê³¼ ì•„ì´ë”” ì €ì¥ë˜ì–´ì•¼ í•¨... ê·¼ë° ì–´ë–»ê²Œ ì‘ì„±í•´ì•¼í• ì§€ ëª¨ë¥´ê² ìŒ...      -->

          <input type="hidden" name="mccname" th:value="${session.member.mcname}">
          <input type="hidden" name="bcno" th:value="${session.board.bno}">
          <input type="hidden" name="mcid" th:value="${session.member.mid}">
          <input id="replyup" type="text" name="ccontent" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”">
        </form>
      </div>
    </th:block>
    <th:block th:unless="${session.member}!=null">
      <input placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì‹œë ¤ë©´, ë¨¼ì € ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”" readonly>
      <button id="login">ë¡œê·¸ì¸</button>
      <div class="comment_area" >

      </div>

    </th:block>
  </div>
  <button id="moreComment">ëŒ“ê¸€ ë”ë³´ê¸°</button>
</div>


<!--  &lt;!&ndash;  ì‘ì„±ëœ ëŒ“ê¸€ ì¶œë ¥ ë¶€ë¶„  &ndash;&gt;-->
<!--  <div class="comment" th:each="comment:${commentList}">-->
<!--    <div class="info">-->
<!--      <span th:text="${comment.mcname}"></span> Â·-->
<!--      <span th:text="${comment.mcid.mid}"></span> Â·-->
<!--      &lt;!&ndash;            <span th:text="${}"></span>&ndash;&gt;-->
<!--    </div>-->
<!--    <div class="ccontent" th:text="${comment.ccontent}">-->
<!--      <span><button type="submit" name="submit" value="update">ìˆ˜ì •</button></span>-->
<!--      <span><button type="submit" name="submit" value="delete">ì‚­ì œ</button></span>-->
<!--    </div>-->
<!--  </div>-->


</body>
<script th:inline="javascript">
    let msg = [[${msg}]];
    if (msg != null) {
        alert(msg);
    }


    let mid = null;

    if ([[${session.member}]] != null) {

        mid = [[${session.member?.mid}]]

        if ([[${session.member}]] === [[${board.mbid}]]) {
            $("#upbtn").removeClass("hidden");
            $("#delbtn").removeClass("hidden");
        }

        //
        // $(".post_wrap").on("createElement", ".deleteCommentBtn", function(){
        //    if( $(this).prev(".post_writer").text()==mid){
        //        $(".deleteCommentBtn").removeClass("hidden")
        //    }
        //
        // })


    }


    let nowBno = [[${session.board.bno}]]


    let cPageNum = null;
    console.log(cPageNum)

    getComment(cPageNum, mid, nowBno)

    //ëŒ“ê¸€ 5ê°œì”© ì¶œë ¥
    function getComment(cPageNum, mid, nowBno) {
        let nowDate = new Date().getTime();
        $.ajax({
            type: 'get',
            url: "getCommentList",
            dataType: "JSON",
            data: {
                'cPageNum': cPageNum,
                'mid': mid,
                'bno': nowBno
            },
            success: [function (commentList) {

                $.each(commentList, function (idx, comment) {

                    if (commentList == null) {
                        return;
                    }
                    let fromNow;

                    let a = new Date(comment.cdate);
                    let writtenDate = a.getTime();

                    console.log("cdate =  " + comment.cdate)

                    let timeGap = (nowDate - writtenDate) / 1000 / 60;

                    if (timeGap < 1) {
                        fromNow = "ë°©ê¸ˆì „";
                    } else if (1 <= timeGap && timeGap < 60) {
                        fromNow = Math.floor(timeGap) + "ë¶„ì „";
                    } else if (60 <= timeGap && timeGap < 60 * 24) {
                        fromNow = Math.floor(timeGap / 60) + "ì‹œê°„ì „";
                    } else if (60 * 24 <= timeGap && timeGap < 60 * 24 * 30) {
                        fromNow = Math.floor(timeGap / 60 / 24) + "ì¼ì „";
                    } else if (60 * 24 * 30 <= timeGap && timeGap < 60 * 24 * 30 * 12) {
                        fromNow = Math.floor(timeGap / 60 / 24 / 30) + "ë‹¬ì „";
                    } else {
                        fromNow = Math.floor(timeGap / 60 / 24 / 30 / 12) + "ë…„ì „";
                    }
                    console.log(fromNow);

                    let $commentWrap = $('<div class="comment_wrap">').appendTo('.comment_area');
                    let $infoWrap = ($commentWrap).append('<div class="info_wrap">');

                    $('<span class="c_company">').html(comment.mcid.mcname + " Â· ").appendTo($commentWrap);
                    $('<span class="c_writer">').html(comment.mcid.mid + '</br>').appendTo($commentWrap);
                    $('<div class="c_content">').html(comment.ccontent).appendTo($commentWrap);


                    $('<span class="c_info">').html("ğŸ‘ : " + comment.clike).appendTo($infoWrap);
                    $('<span class="c_date c_info">').html(fromNow).appendTo($infoWrap);
                    $('<button class="deleteCommentBtn hidden">').text("ëŒ“ê¸€ ì‚­ì œ").appendTo($infoWrap);
                    $('<span class="hidden">').html(comment.cno).appendTo($infoWrap);
                });
            }],
            error: [function (error) {
                console.log(error)
                console.log("pno = " + cPageNum)
            }]
        });
    }


    $("#moreComment").click(function () {
        cPageNum++
        getComment(cPageNum, mid, nowBno)
    })


    $("#login").click(function () {
            location.href = "login"
        }
    )


    //ë’¤ë¡œê°€ê¸° ë²„íŠ¼
    $("#backbtn").click(function () {
        location.href = "/?category=" + [[${board.bcategory}]];
    });

    //ê²Œì‹œê¸€ ìˆ˜ì •
    $("#upbtn").click(function () {
        location.href = "updateFrm?bno=" + nowBno;
    });
    //ê²Œì‹œê¸€ ì‚­ì œ
    $("#delbtn").click(function () {
        let checkDel = confirm("ê¸€ ì œëª© '" + [[${board.btitle}]] + "'ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")
        if (checkDel) {
            location.href = "delete?bno=" + nowBno;
        } else {
            alert("ì‚­ì œê°€ ì·¨ì†ŒëìŠµë‹ˆë‹¤.")
        }

    });

    $(document).on("click", ".deleteCommentBtn", function () {

        let cno = $(this).next().html();
        console.log(cno)
        location.href = "cDeleteProc?cno=" + cno
    })


</script>
</html>